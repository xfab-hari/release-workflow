name: Deploy Images to GHCR

on:
  push:
    tags:
      - "v[0-9].[0-9]+.[0-9]+"

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: 'Login to GitHub Container Registry'
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{github.actor}}
        password: ${{secrets.GITHUB_TOKEN}}

    - name: Build and Push Backend Image
      run: |
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --file Dockerfile \
          --target backend-builder \
          -t ghcr.io/${{ github.repository_owner }}/xfab-backend:latest \
          -t ghcr.io/${{ github.repository_owner }}/xfab-backend:${{ github.ref_name }} \
          --push .


    # - name: Build and Push Backend Image
    #   run: |
    #     docker buildx build \
    #       --platform linux/amd64 \
    #       --file Dockerfile \
    #       --target backend-builder \
    #       -t ghcr.io/${{ github.repository_owner }}/xfab-backend:latest \
    #       -t ghcr.io/${{ github.repository_owner }}/xfab-backend:${{ github.ref_name }} \
    #       --push .

    # - name: Build and Push Frontend Image
    #   run: |
    #     docker buildx build \
    #       --platform linux/amd64 \
    #       --file Dockerfile \
    #       --target xfab-frontend \
    #       -t ghcr.io/${{ github.repository_owner }}/xfab-frontend:latest \
    #       -t ghcr.io/${{ github.repository_owner }}/xfab-frontend:${{ github.ref_name }} \
    #       --push .
